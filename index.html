<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diseños Aguilar | Muebles de Lujo en Valledupar</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carga de Iconos (Lucide Icons) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, 
            signOut 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        // Importamos todas las funciones necesarias directamente y las adjuntamos a window para usarlas globalmente
        import { 
            getFirestore, doc, collection, onSnapshot, query, addDoc, updateDoc, deleteDoc, 
            getDoc, setDoc, serverTimestamp, getDocs
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Adjuntar funciones de Firebase a window para que el script principal pueda acceder a ellas
        window.firestore = {
            doc, collection, onSnapshot, query, addDoc, updateDoc, deleteDoc, 
            getDoc, setDoc, serverTimestamp, getDocs
        };
        // Dejamos las funciones de auth necesarias para el control de sesión
        window.authFunctions = {
            signInAnonymously, signOut
        };


        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Credenciales de administración de prueba (Solo para validación local/simulada)
        const ADMIN_EMAIL = 'admin@aguilar.com';
        const ADMIN_PASSWORD = '123456';


        if (Object.keys(firebaseConfig).length > 0) {
            const app = initializeApp(firebaseConfig);
            window.db = getFirestore(app);
            window.auth = getAuth(app);
            
            
            // Authentication and Firestore setup
            onAuthStateChanged(window.auth, async (user) => {
                
                if (user) {
                    window.userId = user.uid;
                } else {
                    window.userId = crypto.randomUUID();
                }
                
                // Si el usuario no está autenticado, aseguramos que inicie sesión con Anonymous o Custom Token
                if (!user) {
                    try {
                        if (initialAuthToken) {
                            // Intentamos iniciar con token personalizado
                            await signInWithCustomToken(window.auth, initialAuthToken);
                            window.userId = window.auth.currentUser.uid;
                        } else {
                            // Intentamos iniciar sesión anónimamente
                            await signInAnonymously(window.auth);
                            window.userId = window.auth.currentUser.uid;
                        }
                    } catch (error) {
                         // Fallback si la autenticación falla por completo
                         console.error("Error durante el inicio de sesión inicial:", error);
                         // Revertir a un ID aleatorio en caso de fallo crítico de Auth
                         window.userId = crypto.randomUUID(); 
                    }
                }
                
                // Una vez que Firebase está listo y el usuario tiene un ID (autenticado o aleatorio), inicializamos los listeners de datos
                if (window.db && window.userId) {
                    window.isAuthReady = true;
                    // Llamamos a initAppListeners
                    window.initAppListeners(window.db, window.userId, window.firestore.collection, window.firestore.onSnapshot);
                    console.log(`Firestore ready. Session ID: ${window.userId}.`);
                    
                    document.getElementById('user-id-display').textContent = `ID Usuario: ${window.userId}`;
                }
            });
        } else {
             console.warn("Firebase configuration not found. Running in local simulation mode.");
        }
    </script>
    
    <style>
        /* Estilos personalizados para el toque profesional */
        :root {
            --color-primary: #5D4037; /* Marrón oscuro para simular madera noble */
            --color-secondary: #D7CCC8; /* Beige claro/crema */
            --color-accent: #FFD700; /* Oro/Amarillo para acentos de lujo */
        }
        .text-primary { color: var(--color-primary); }
        .bg-primary { background-color: var(--color-primary); }
        .text-accent { color: var(--color-accent); }
        .shadow-luxury {
            box-shadow: 0 10px 30px -5px rgba(93, 64, 55, 0.3);
        }

        /* Estilo para la sección Hero, usando una imagen de placeholder elegante */
        #hero-section {
            background-image: url('https://placehold.co/1920x800/5D4037/FFFFFF/webp?text=Salas+y+Comedores+Exclusivos');
            background-size: cover;
            background-position: center;
            min-height: 80vh;
        }

        /* Estilo para el botón de carga del LLM */
        .loading-button {
            background-color: #f1f1f1;
            color: #5D4037;
            cursor: not-allowed;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* Animaciones */
        @keyframes ping-once {
            0% { transform: scale(1); opacity: 0.7; }
            50% { transform: scale(1.2); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        .animate-ping-once {
            animation: ping-once 0.5s ease-out;
        }

        /* Estilo para el panel de administración */
        #admin-panel {
            background-color: #fcfcfc;
        }
    </style>
</head>
<body class="font-sans antialiased text-gray-800 bg-gray-50">

    <!-- Navbar -->
    <header class="sticky top-0 z-50 bg-white shadow-md">
        <nav class="container mx-auto px-4 sm:px-6 lg:px-8 flex items-center justify-between h-20">
            <a href="#hero-section" class="text-2xl font-bold text-primary tracking-widest">DISEÑOS AGUILAR</a>
            <div class="flex items-center space-x-6">
                <a href="#catalogos" class="text-gray-600 hover:text-primary transition duration-300">Catálogos</a>
                <a href="#comprar" class="text-gray-600 hover:text-primary transition duration-300">Comprar</a>
                <a href="#cotizar" class="text-gray-600 hover:text-primary transition duration-300">
                    <button class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-opacity-90 transition duration-300 shadow-lg">Cotizar Ahora</button>
                </a>
                <!-- Botón de Administración -->
                <button onclick="toggleAdminPanel()" class="px-3 py-1 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition duration-300 text-sm font-medium">Admin</button>
            </div>
        </nav>
    </header>
    
    <!-- User ID Display for Debugging -->
    <div id="user-id-display" class="bg-primary text-white text-xs p-1 text-center font-mono opacity-80">
        Cargando ID...
    </div>

    <!-- Panel de Administración (CMS) - Oculto por defecto -->
    <section id="admin-container" class="hidden">
        
        <!-- Login Form -->
        <div id="admin-login" class="container mx-auto px-4 sm:px-6 lg:px-8 py-10 my-10 max-w-md bg-white rounded-xl shadow-luxury border-t-4 border-accent">
            <h2 class="text-3xl font-bold text-primary mb-6 text-center">Acceso de Administrador</h2>
            <p class="text-center text-sm text-gray-500 mb-6">Usa las credenciales de prueba: **admin@aguilar.com** / **123456**</p>
            <form onsubmit="handleAdminLogin(event)">
                <div class="space-y-4">
                    <input type="email" id="admin-email" placeholder="Correo Electrónico" required 
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                    <input type="password" id="admin-password" placeholder="Contraseña" required 
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                    <button type="submit" class="w-full py-3 bg-primary text-white rounded-lg hover:bg-opacity-90 transition duration-300 font-semibold" id="login-button">
                        Iniciar Sesión
                    </button>
                    <div id="login-message" class="text-center text-red-500 font-medium mt-2 hidden"></div>
                </div>
            </form>
        </div>

        <!-- Admin Panel (CRUD) -->
        <div id="admin-panel" class="hidden container mx-auto px-4 sm:px-6 lg:px-8 py-10 border-b-4 border-accent">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-primary">Panel de Productos</h2>
                <button onclick="handleAdminLogout()" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition duration-300 flex items-center">
                    <i data-lucide="log-out" class="w-4 h-4 mr-2"></i> Cerrar Sesión
                </button>
            </div>
            
            <!-- Formulario para Añadir/Editar Producto -->
            <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
                <h3 class="text-xl font-semibold text-primary mb-4" id="admin-form-title">Añadir Nuevo Producto</h3>
                <form id="product-form" onsubmit="handleProductSubmit(event)">
                    <input type="hidden" id="product-id">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="text" id="product-name" placeholder="Nombre del Producto" required class="p-3 border rounded-lg focus:ring-primary focus:border-primary">
                        <input type="number" id="product-price" placeholder="Precio (COP)" required min="0" class="p-3 border rounded-lg focus:ring-primary focus:border-primary">
                    </div>
                    <textarea id="product-description" rows="3" placeholder="Descripción breve del producto" required class="mt-4 p-3 w-full border rounded-lg focus:ring-primary focus:border-primary"></textarea>
                    <input type="text" id="product-image" placeholder="URL Imagen (placehold.co)" value="https://placehold.co/400x300/A1887F/FFFFFF?text=NEW+ITEM" required class="mt-4 p-3 w-full border rounded-lg focus:ring-primary focus:border-primary">
                    <div class="flex justify-end mt-4 space-x-3">
                        <button type="button" onclick="resetProductForm()" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition duration-300">Cancelar/Nuevo</button>
                        <button type="submit" class="px-6 py-2 bg-primary text-white rounded-lg hover:bg-opacity-80 transition duration-300" id="form-submit-button">Añadir Producto</button>
                    </div>
                </form>
            </div>

            <!-- Lista de Productos Administrables -->
            <h3 class="text-xl font-semibold text-primary mb-4">Productos en Venta (Base de Datos)</h3>
            <div id="admin-product-list" class="space-y-4">
                <p class="text-gray-500">Cargando productos...</p>
            </div>
        </div>
    </section>

    <!-- Hero Section con Interacción de Palabras e Imágenes (Simulada) -->
    <section id="hero-section" class="relative flex items-center justify-center text-center text-white p-8">
        <div class="absolute inset-0 bg-black bg-opacity-40"></div>
        <div class="z-10 max-w-4xl space-y-6">
            <h1 id="hero-title" class="text-5xl md:text-7xl font-extrabold tracking-tight transition duration-500">
                Diseños Aguilar: Elegancia en Cada Mueble.
            </h1>
            <p id="hero-subtitle" class="text-xl md:text-2xl font-light opacity-90 transition duration-500">
                Transformando espacios con el arte de la madera y el diseño.
            </p>

            <!-- Interacción de Palabras con Efecto Visual -->
            <div class="flex flex-wrap justify-center gap-6 mt-10">
                <button onmouseover="updateHero('Salas', 'Donde el confort se encuentra con el diseño. Explora nuestros sofás modulares.')"
                        onmouseout="resetHero()"
                        class="text-xl font-semibold px-6 py-3 rounded-full border-2 border-white hover:bg-white hover:text-primary transition duration-300">
                    Salas
                </button>
                <button onmouseover="updateHero('Comedores', 'Mesas únicas para momentos inolvidables. La familia se reúne aquí.')"
                        onmouseout="resetHero()"
                        class="text-xl font-semibold px-6 py-3 rounded-full border-2 border-white hover:bg-white hover:text-primary transition duration-300">
                    Comedores
                </button>
                <button onmouseover="updateHero('Dormitorios', 'El santuario de tu descanso. Calidad y ergonomía superior.')"
                        onmouseout="resetHero()"
                        class="text-xl font-semibold px-6 py-3 rounded-full border-2 border-white hover:bg-white hover:text-primary transition duration-300">
                    Dormitorios
                </button>
            </div>
        </div>
    </section>

    <!-- Separador -->
    <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-10">
        <hr class="border-t-2 border-primary opacity-20">
    </div>

    <!-- Catálogos (Sección Informativa) -->
    <section id="catalogos" class="container mx-auto px-4 sm:px-6 lg:px-8 py-16">
        <h2 class="text-4xl font-bold text-center text-primary mb-12">Nuestros Catálogos de Muebles</h2>
        <p class="text-center text-gray-600 max-w-3xl mx-auto mb-16">
            Descubre la colección completa de Diseños Aguilar. Cada pieza está pensada para ofrecer durabilidad, estilo y la máxima comodidad.
        </p>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            <!-- Categoría 1: Salas -->
            <div class="bg-white rounded-xl shadow-luxury overflow-hidden transform hover:scale-[1.02] transition duration-300 group">
                <img src="https://placehold.co/600x400/D7CCC8/5D4037/webp?text=Coleccion+Salas" alt="Salas de Diseño" class="w-full h-64 object-cover">
                <div class="p-6">
                    <h3 class="text-2xl font-semibold text-primary mb-2">Salas de Estar</h3>
                    <p class="text-gray-600 mb-4" id="desc-salas">Sofás, sillones reclinables y centros de entretenimiento modulares.</p>
                    <a href="#" class="text-primary font-medium hover:underline flex items-center mb-3">
                        Ver Catálogo <i data-lucide="arrow-right" class="w-4 h-4 ml-2"></i>
                    </a>
                    <!-- ✨ TTS Asistente -->
                    <button onclick="speakDescription('desc-salas', 'Kore')" class="w-full py-2 bg-secondary text-primary rounded-lg text-sm hover:bg-opacity-80 transition duration-300 flex items-center justify-center">
                        <i data-lucide="volume-2" class="w-4 h-4 mr-2"></i> ✨ Escuchar Descripción
                    </button>
                </div>
            </div>

            <!-- Categoría 2: Comedores -->
            <div class="bg-white rounded-xl shadow-luxury overflow-hidden transform hover:scale-[1.02] transition duration-300 group">
                <img src="https://placehold.co/600x400/BCAAA4/5D4037/webp?text=Mesas+y+Sillas" alt="Comedores y Mesas" class="w-full h-64 object-cover">
                <div class="p-6">
                    <h3 class="text-2xl font-semibold text-primary mb-2">Comedores</h3>
                    <p class="text-gray-600 mb-4" id="desc-comedores">Mesas en maderas nobles, sillas tapizadas y vitrinas elegantes.</p>
                    <a href="#" class="text-primary font-medium hover:underline flex items-center mb-3">
                        Ver Catálogo <i data-lucide="arrow-right" class="w-4 h-4 ml-2"></i>
                    </button>
                </div>
            </div>

            <!-- Categoría 3: Dormitorios -->
            <div class="bg-white rounded-xl shadow-luxury overflow-hidden transform hover:scale-[1.02] transition duration-300 group">
                <img src="https://placehold.co/600x400/795548/FFFFFF/webp?text=Camas+y+Closets" alt="Camas y Dormitorios" class="w-full h-64 object-cover">
                <div class="p-6">
                    <h3 class="text-2xl font-semibold text-primary mb-2">Dormitorios</h3>
                    <p class="text-gray-600 mb-4" id="desc-dormitorios">Camas a medida, armarios de lujo y cómodas funcionales.</p>
                    <a href="#" class="text-primary font-medium hover:underline flex items-center mb-3">
                        Ver Catálogo <i data-lucide="arrow-right" class="w-4 h-4 ml-2"></i>
                    </a>
                    <!-- ✨ TTS Asistente -->
                    <button onclick="speakDescription('desc-dormitorios', 'Charon')" class="w-full py-2 bg-secondary text-primary rounded-lg text-sm hover:bg-opacity-80 transition duration-300 flex items-center justify-center">
                        <i data-lucide="volume-2" class="w-4 h-4 mr-2"></i> ✨ Escuchar Descripción
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- Comprar (Sección de E-commerce con productos dinámicos de Firestore) -->
    <section id="comprar" class="container mx-auto px-4 sm:px-6 lg:px-8 py-16 bg-gray-100 rounded-xl my-12">
        <h2 class="text-4xl font-bold text-center text-primary mb-12">Comprar Productos Destacados</h2>
        <div id="product-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8">
            <p class="text-center text-gray-500 col-span-full" id="loading-products">Cargando productos dinámicos...</p>
            <!-- Productos cargados desde Firestore se insertarán aquí -->
        </div>

        <!-- Carrito de Compras (Botón Flotante) -->
        <div id="cart-button" class="fixed bottom-6 right-6 z-50">
            <button onclick="showCartModal()" class="flex items-center justify-center w-16 h-16 bg-accent text-primary rounded-full shadow-2xl hover:scale-105 transition duration-300">
                <i data-lucide="shopping-bag" class="w-6 h-6"></i>
                <span id="cart-count" class="absolute top-0 right-0 transform translate-x-1/4 -translate-y-1/4 bg-red-600 text-white text-xs font-bold px-2 py-0.5 rounded-full">0</span>
            </button>
        </div>
    </section>

    <!-- Cotizar (Formulario Profesional) -->
    <section id="cotizar" class="container mx-auto px-4 sm:px-6 lg:px-8 py-16">
        <div class="max-w-3xl mx-auto bg-white p-8 md:p-12 rounded-xl shadow-luxury border-t-4 border-primary">
            <h2 class="text-4xl font-bold text-center text-primary mb-4">Solicita tu Cotización Personalizada</h2>
            <p class="text-center text-gray-600 mb-8">
                ¿Buscas algo a la medida? Describe tu proyecto, o usa nuestro generador de ideas ✨.
            </p>
            
            <!-- ✨ Generador de Ideas de Diseño (Gemini API) -->
            <div class="mb-8 p-6 bg-gray-100 rounded-lg border border-gray-200">
                <h3 class="text-xl font-semibold text-primary mb-3 flex items-center">
                    <i data-lucide="sparkles" class="w-5 h-5 mr-2 text-accent"></i> Generador de Ideas de Muebles
                </h3>
                <div class="flex flex-col md:flex-row gap-3">
                    <input type="text" id="design-keyword" placeholder="Ej: Minimalista, Lujoso, Estilo Escandinavo..." 
                           class="flex-grow px-4 py-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                    <button id="generate-button" onclick="generateDesignIdea()" 
                            class="px-6 py-3 bg-accent text-primary font-semibold rounded-lg hover:bg-yellow-600 transition duration-300 shadow-md flex items-center justify-center whitespace-nowrap">
                        <i data-lucide="wand-2" class="w-5 h-5 mr-2"></i> Generar Diseño
                    </button>
                </div>
                <div id="llm-output-container" class="mt-4 hidden p-4 bg-white border border-gray-300 rounded-lg">
                    <p class="text-sm font-semibold text-primary">Sugerencia de Diseño:</p>
                    <p id="llm-output" class="text-gray-700 whitespace-pre-wrap"></p>
                    <button onclick="fillQuoteDetails()" id="apply-llm-output" class="mt-3 text-sm bg-primary text-white px-3 py-1 rounded-full hover:bg-opacity-80 transition duration-300">
                        Usar en Cotización
                    </button>
                </div>
            </div>
            <!-- Fin Generador de Ideas -->


            <form id="quote-form" onsubmit="handleQuoteSubmit(event)">
                <div class="space-y-6">
                    <div>
                        <label for="name" class="block text-sm font-medium text-gray-700">Nombre Completo</label>
                        <input type="text" id="name" name="name" required class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                    </div>
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-700">Correo Electrónico</label>
                        <input type="email" id="email" name="email" required class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                    </div>
                    <div>
                        <label for="phone" class="block text-sm font-medium text-gray-700">Teléfono de Contacto</label>
                        <input type="tel" id="phone" name="phone" required class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary" placeholder="Ej: 316 5790920">
                    </div>
                    <div>
                        <label for="details" class="block text-sm font-medium text-gray-700">Detalles de la Cotización (Dimensiones, Materiales, Tipo de Mueble)</label>
                        <textarea id="details" name="details" rows="5" required class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary"></textarea>
                    </div>
                    <div class="flex justify-center">
                        <button type="submit" class="w-full md:w-auto px-8 py-3 bg-primary text-white font-semibold rounded-lg hover:bg-opacity-90 transition duration-300 shadow-xl flex items-center justify-center">
                            <i data-lucide="send" class="w-5 h-5 mr-2"></i> Enviar Solicitud de Cotización
                        </button>
                    </div>
                    <div id="quote-message" class="text-center mt-4 text-green-600 font-medium hidden"></div>
                </div>
            </form>
        </div>
    </section>

    <!-- Footer -->
    <footer class="bg-primary text-white mt-12">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-10">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 border-b border-white border-opacity-30 pb-8 mb-8">
                <!-- Columna 1: Logo y Misión -->
                <div>
                    <h4 class="text-2xl font-bold tracking-widest mb-4">Diseños Aguilar</h4>
                    <p class="text-sm opacity-80">
                        Fábrica de muebles de alta calidad, transformando hogares en Valledupar y la región.
                    </p>
                </div>
                <!-- Columna 2: Contacto -->
                <div>
                    <h4 class="text-lg font-semibold mb-4">Contáctanos</h4>
                    <ul class="space-y-2 text-sm opacity-80">
                        <li class="flex items-center"><i data-lucide="map-pin" class="w-4 h-4 mr-2"></i> Cra. 21 #19-55, Valledupar, Cesar.</li>
                        <li class="flex items-center"><i data-lucide="phone" class="w-4 h-4 mr-2"></i> Teléfono: 316 5790920</li>
                        <li class="flex items-center"><i data-lucide="mail" class="w-4 h-4 mr-2"></i> info@disenosaguilar.com</li>
                    </ul>
                </div>
                <!-- Columna 3: Enlaces Rápidos -->
                <div>
                    <h4 class="text-lg font-semibold mb-4">Navegación</h4>
                    <ul class="space-y-2 text-sm opacity-80">
                        <li><a href="#catalogos" class="hover:underline">Catálogos</a></li>
                        <li><a href="#comprar" class="hover:underline">Comprar</a></li>
                        <li><a href="#cotizar" class="hover:underline">Cotizar</a></li>
                    </ul>
                </div>
            </div>
            <div class="text-center text-sm opacity-60">
                &copy; 2024 Diseños Aguilar. Todos los derechos reservados.
            </div>
        </div>
    </footer>

    <!-- Modal para el Carrito de Compras (Simulado) -->
    <div id="cart-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-[100]">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-lg transform transition-all duration-300 scale-100">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h3 class="text-2xl font-bold text-primary">Tu Carrito de Compras</h3>
                <button onclick="hideCartModal()" class="text-gray-500 hover:text-red-600"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <div id="cart-items-list" class="max-h-80 overflow-y-auto space-y-4">
                <p id="empty-cart-message" class="text-gray-500 text-center">El carrito está vacío.</p>
                <!-- Items se insertarán aquí -->
            </div>
            <div class="border-t pt-4 mt-4">
                <div class="flex justify-between font-bold text-lg mb-4">
                    <span>Total:</span>
                    <span id="cart-total-price" class="text-accent">$0 COP</span>
                </div>
                <button onclick="simulatePurchase()" class="w-full py-3 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition duration-300">
                    <i data-lucide="check-circle" class="w-5 h-5 mr-2 inline-block"></i> Finalizar Compra (Simulado)
                </button>
            </div>
        </div>
    </div>
    
    <!-- Script principal para interactividad, lógica y Gemini API -->
    <script>
        // Clave API (se mantendrá vacía para que Canvas la inyecte)
        const apiKey = ""; 
        const LLM_MODEL = 'gemini-2.5-flash-preview-05-20';
        const TTS_MODEL = 'gemini-2.5-flash-preview-tts';
        const ADMIN_EMAIL = 'admin@aguilar.com';
        const ADMIN_PASSWORD = '123456'; // Para referencia

        // Variables globales de la aplicación
        let cart = [];
        let allProducts = []; // Para almacenar productos cargados desde Firestore
        let currentEditingProduct = null;
        window.isAdminLoggedIn = false; // Estado de autenticación de Admin

        // Lista de productos de muestra para precargar si la base de datos está vacía
        const DEFAULT_PRODUCTS = [
            {
                name: "Comedor 4 Puestos 'Nogal Clásico'",
                price: 800000,
                description: "Elegante comedor de cuatro puestos, perfecto para espacios reducidos. Fabricado en madera de nogal, diseño funcional y moderno.",
                image: "https://i.imgur.com/fpoWsQe.jpeg" 
            },
            {
                name: "Juego de Sala Modular 'Confort'",
                price: 1200000,
                description: "Lujoso juego de sala modular, hecho a medida para el máximo confort familiar. Tapicería anti-manchas y estructura reforzada.",
                image: "https://i.imgur.com/fpoWsQe.jpeg"
            },
            {
                name: "Mesa Auxiliar Escandinava",
                price: 150000,
                description: "Mesa auxiliar pequeña con patas de pino. Ideal para rincones de lectura o como mesita de noche.",
                image: "https://placehold.co/400x300/F0F0F0/000000?text=AUXILIAR"
            },
            {
                name: "Silla de Oficina Ergonómica",
                price: 350000,
                description: "Silla de oficina con soporte lumbar y altura ajustable. Diseño moderno y minimalista.",
                image: "https://placehold.co/400x300/BCAAA4/5D4037/webp?text=SILLA+OFICINA"
            }
        ];


        // Inicializa los iconos de Lucide
        document.addEventListener('DOMContentLoaded', (event) => {
            lucide.createIcons();
            resetHero();
            // Asegura que el contenedor de administración esté visible para manejar el login/panel
            document.getElementById('admin-container').classList.remove('hidden');
            // Al cargar, aseguramos que el panel de login esté visible (no logeado inicialmente)
            updateAdminUI(); 
        });

        // --- LÓGICA DE AUTENTICACIÓN ---
        
        function updateAdminUI() {
            const loginSection = document.getElementById('admin-login');
            const panelSection = document.getElementById('admin-panel');
            
            if (window.isAdminLoggedIn) {
                loginSection.classList.add('hidden');
                panelSection.classList.remove('hidden');
                // No mostramos notificación aquí para evitar spam de notificaciones en el listener de Auth.
            } else {
                panelSection.classList.add('hidden');
                // Solo muestra el login si el contenedor general está visible
                if (document.getElementById('admin-container').classList.contains('hidden')) {
                    loginSection.classList.add('hidden');
                } else {
                    loginSection.classList.remove('hidden');
                }
            }
        }
        
        function toggleAdminPanel() {
            const adminContainer = document.getElementById('admin-container');
            adminContainer.classList.toggle('hidden');
            
            if (!adminContainer.classList.contains('hidden')) {
                // Si abrimos el contenedor, actualizamos la vista (muestra login o panel)
                updateAdminUI();
            }
            
            if (!adminContainer.classList.contains('hidden') && window.isAdminLoggedIn) {
                 document.getElementById('admin-panel').scrollIntoView({ behavior: 'smooth' });
            }
            
        }

        async function handleAdminLogin(event) {
            event.preventDefault();
            const email = document.getElementById('admin-email').value;
            const password = document.getElementById('admin-password').value;
            const messageDiv = document.getElementById('login-message');
            const loginButton = document.getElementById('login-button');

            messageDiv.classList.add('hidden');
            loginButton.disabled = true;
            loginButton.textContent = 'Iniciando...';
            
            // --- Lógica de Simulación de Autenticación ---
            if (email === ADMIN_EMAIL && password === ADMIN_PASSWORD) {
                try {
                    // Si las credenciales coinciden, iniciamos sesión anónimamente para obtener un UID y permiso de escritura
                    const { signInAnonymously } = window.authFunctions;
                    await signInAnonymously(window.auth);

                    // Establecemos el estado de administrador y actualizamos la UI
                    window.isAdminLoggedIn = true;
                    updateAdminUI();
                    document.getElementById('admin-panel').scrollIntoView({ behavior: 'smooth' });
                    showNotification("¡Bienvenido, Administrador!", 'bg-green-600');
                    
                    // --- PRECARGA DE PRODUCTOS AL INICIAR SESIÓN ---
                    const { getDocs, collection, addDoc } = window.firestore;
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    const productsCollectionRef = collection(window.db, `/artifacts/${appId}/public/data/products`);
                    
                    const snapshot = await getDocs(productsCollectionRef);
                    if (snapshot.empty) {
                        console.log("BD vacía. Precargando productos de muestra...");
                        for (const product of DEFAULT_PRODUCTS) {
                            await addDoc(productsCollectionRef, product);
                        }
                        showNotification("Productos de muestra cargados automáticamente.", 'bg-yellow-600');
                    }
                    // --- FIN PRECARGA ---
                    
                } catch (error) {
                    // Esto solo debería ocurrir si la autenticación anónima está deshabilitada
                    console.error("Error al iniciar sesión anónimamente (Admin Login):", error);
                    messageDiv.textContent = 'Error de conexión con Firebase. Contacta soporte.';
                    messageDiv.classList.remove('hidden');
                }
            } else {
                // Credenciales no válidas
                messageDiv.textContent = 'Error: Credenciales inválidas. Intenta de nuevo.';
                messageDiv.classList.remove('hidden');
            }
            
            loginButton.disabled = false;
            loginButton.textContent = 'Iniciar Sesión';
        }
        
        async function handleAdminLogout() {
            try {
                const { signOut } = window.authFunctions;
                await signOut(window.auth);
                window.isAdminLoggedIn = false;
                updateAdminUI();
                showNotification("Sesión cerrada correctamente.", 'bg-yellow-600');
            } catch (error) {
                console.error("Logout Error:", error);
                showNotification("Error al cerrar sesión.", 'bg-red-600');
            }
        }

        // Configuración de Firestore Listeners
        window.initAppListeners = function(db, userId, collection, onSnapshot) {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const productsCollectionPath = `/artifacts/${appId}/public/data/products`;
            const productsCollection = collection(db, productsCollectionPath);

            // Listener para PRODUCTOS (público)
            onSnapshot(productsCollection, (snapshot) => {
                allProducts = [];
                snapshot.forEach((doc) => {
                    allProducts.push({ id: doc.id, ...doc.data() });
                });
                console.log("Productos actualizados:", allProducts.length);
                renderProducts(allProducts);
                // NOTA: renderAdminProducts maneja su propio estado de window.isAdminLoggedIn
                renderAdminProducts(allProducts); 
            }, (error) => {
                console.error("Error al cargar productos desde Firestore:", error);
                
                // --- FIX: Error de Permisos y TypeError ---
                // Si el error es de permisos, asumimos que es porque las reglas de seguridad no permiten 
                // la lectura sin autenticación explícita o el usuario aún no tiene UID.
                // Revertimos la UI a un mensaje genérico.
                const loadingElement = document.getElementById('loading-products');
                if (loadingElement) { // Verificación añadida para el segundo TypeError
                    loadingElement.textContent = 'Error de permisos de Firestore. El catálogo está temporalmente no disponible.';
                }
                // --- FIN FIX ---
            });
        }
        
        // --- FUNCIONES DE ADMINISTRACIÓN (CRUD) ---

        function resetProductForm() {
            document.getElementById('product-form').reset();
            document.getElementById('product-id').value = '';
            document.getElementById('admin-form-title').textContent = 'Añadir Nuevo Producto';
            document.getElementById('form-submit-button').textContent = 'Añadir Producto';
            currentEditingProduct = null;
        }

        function editProduct(product) {
            if (!window.isAdminLoggedIn) {
                 showNotification("Acceso denegado. Inicia sesión como administrador.", 'bg-red-600');
                 return;
            }
            document.getElementById('product-id').value = product.id;
            document.getElementById('product-name').value = product.name;
            document.getElementById('product-price').value = product.price;
            document.getElementById('product-description').value = product.description;
            document.getElementById('product-image').value = product.image;

            document.getElementById('admin-form-title').textContent = `Editar: ${product.name}`;
            document.getElementById('form-submit-button').textContent = 'Guardar Cambios';
            currentEditingProduct = product;
            document.getElementById('admin-panel').scrollIntoView({ behavior: 'smooth' });
        }

        async function deleteProduct(id, name) {
             if (!window.isAdminLoggedIn) {
                 showNotification("Acceso denegado. Inicia sesión como administrador.", 'bg-red-600');
                 return;
             }
             // Usamos un modal UI en lugar de confirm()
             if (!await showConfirmationModal(`¿Estás seguro de que quieres eliminar el producto "${name}"?`)) return;

             try {
                const { doc, deleteDoc } = window.firestore;
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const productDocRef = doc(window.db, `/artifacts/${appId}/public/data/products`, id);
                await deleteDoc(productDocRef);
                showNotification(`Producto "${name}" eliminado con éxito.`, 'bg-red-600');
             } catch (error) {
                console.error("Error al eliminar el producto:", error);
                showNotification('Error al eliminar el producto.', 'bg-red-600');
             }
        }


        async function handleProductSubmit(event) {
            event.preventDefault();
            if (!window.isAdminLoggedIn) {
                 showNotification("Acceso denegado. Inicia sesión como administrador para guardar cambios.", 'bg-red-600');
                 return;
            }
            
            const form = event.target;
            const id = form['product-id'].value;
            
            const { collection, doc, addDoc, updateDoc, serverTimestamp } = window.firestore;
            
            const productData = {
                name: form['product-name'].value,
                price: parseFloat(form['product-price'].value),
                description: form['product-description'].value,
                image: form['product-image'].value,
                timestamp: serverTimestamp()
            };

            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const productsCollectionRef = collection(window.db, `/artifacts/${appId}/public/data/products`);

                if (id) {
                    // EDITAR producto
                    const productDocRef = doc(window.db, `/artifacts/${appId}/public/data/products`, id);
                    await updateDoc(productDocRef, productData);
                    showNotification(`Producto "${productData.name}" actualizado con éxito.`, 'bg-green-600');
                } else {
                    // AÑADIR producto
                    await addDoc(productsCollectionRef, productData);
                    showNotification(`Producto "${productData.name}" añadido con éxito.`, 'bg-green-600');
                }

                resetProductForm(); // Limpiar formulario
                
            } catch (error) {
                console.error("Error al guardar el producto:", error);
                showNotification('Error al guardar el producto. Revisa la consola.', 'bg-red-600');
            }
        }

        function renderAdminProducts(products) {
            const adminList = document.getElementById('admin-product-list');
            
            // Solo renderiza la lista si el usuario está logeado como admin
            if (!window.isAdminLoggedIn) {
                 adminList.innerHTML = '<p class="text-gray-500">Inicia sesión en el panel para ver y administrar los productos.</p>';
                 return;
            }
            
            adminList.innerHTML = '';

            if (products.length === 0) {
                adminList.innerHTML = '<p class="text-gray-500">No hay productos en la base de datos.</p>';
                return;
            }

            products.forEach(product => {
                const item = document.createElement('div');
                item.className = 'flex justify-between items-center p-4 bg-white border border-gray-200 rounded-lg shadow-sm';
                
                // Sanitizamos y escapamos las comillas para JSON.stringify en onClick
                const safeProduct = JSON.stringify(product).replace(/"/g, '&quot;');
                
                item.innerHTML = `
                    <div class="flex items-center space-x-4">
                        <img src="${product.image}" onerror="this.onerror=null;this.src='https://placehold.co/50x50/F0F0F0/000000?text=IMG';" class="w-12 h-12 object-cover rounded">
                        <div>
                            <p class="font-semibold text-primary">${product.name}</p>
                            <p class="text-sm text-gray-500">${formatCurrency(product.price)}</p>
                        </div>
                    </div>
                    <div class="space-x-2">
                        <button onclick='editProduct(${safeProduct})' class="p-2 bg-yellow-500 text-white rounded hover:bg-yellow-600 transition">
                            <i data-lucide="edit-2" class="w-4 h-4"></i>
                        </button>
                        <button onclick='deleteProduct("${product.id}", "${product.name}")' class="p-2 bg-red-500 text-white rounded hover:bg-red-600 transition">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                `;
                adminList.appendChild(item);
            });
            lucide.createIcons(); // Re-renderizar iconos
        }

        // --- FUNCIONES DE VISTA PÚBLICA ---

        function renderProducts(products) {
            const productGrid = document.getElementById('product-grid');
            productGrid.innerHTML = ''; // Limpiar la cuadrícula

            if (products.length === 0) {
                productGrid.innerHTML = '<p class="text-center text-gray-500 col-span-full">Aún no hay productos en la tienda. Revisa el Panel de Administración para añadirlos.</p>';
                return;
            }

            products.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'product-card bg-white rounded-xl shadow-lg hover:shadow-2xl transition duration-500 overflow-hidden relative';
                
                // Usamos la URL de la imagen de Firestore (o un fallback si falla)
                const imageUrl = product.image || 'https://placehold.co/400x300/F0F0F0/000000?text=NO+IMAGE';

                productCard.innerHTML = `
                    <img src="${imageUrl}" onerror="this.onerror=null;this.src='https://placehold.co/400x300/F0F0F0/000000?text=IMG+ERROR';" alt="${product.name}" class="w-full h-48 object-cover">
                    <div class="p-4">
                        <h3 class="font-bold text-primary">${product.name}</h3>
                        <p class="text-gray-500 text-sm h-10 overflow-hidden">${product.description}</p>
                        <p class="text-2xl font-semibold text-accent mt-2">${formatCurrency(product.price)}</p>
                        <button onclick="addToCart('${product.name}', ${product.price})" 
                                class="w-full mt-3 py-2 bg-primary text-white rounded-lg text-sm hover:bg-opacity-80 transition duration-300 flex items-center justify-center">
                            <i data-lucide="shopping-cart" class="w-4 h-4 mr-2"></i> Añadir al Carrito
                        </button>
                    </div>
                `;
                productGrid.appendChild(productCard);
            });
            lucide.createIcons();
        }

        // --- LÓGICA TTS y LLM (Generador de Ideas) ---
        
        /*
        * Utilidades API y Manejo de Errores
        */
        const maxRetries = 3;
        
        async function fetchWithRetry(url, options, retries = 0) {
            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response;
            } catch (error) {
                if (retries < maxRetries) {
                    const delay = Math.pow(2, retries) * 1000;
                    // console.log(`Retry ${retries + 1} after ${delay}ms...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return fetchWithRetry(url, options, retries + 1);
                } else {
                    console.error("Fetch failed after multiple retries:", error);
                    throw error;
                }
            }
        }

        /*
        * 1. Generador de Ideas de Diseño (LLM) - Cotizar
        */
        async function generateDesignIdea() {
            const keywordInput = document.getElementById('design-keyword');
            const keyword = keywordInput.value.trim();
            const outputContainer = document.getElementById('llm-output-container');
            const outputElement = document.getElementById('llm-output');
            const generateButton = document.getElementById('generate-button');
            
            if (!keyword) {
                showNotification('Ingresa una palabra clave o estilo de diseño (ej: vintage, moderno, etc.)', 'bg-yellow-500');
                return;
            }

            // Cambiar estado a cargando
            generateButton.disabled = true;
            generateButton.classList.add('loading-button');
            generateButton.innerHTML = '<i data-lucide="loader-2" class="w-5 h-5 mr-2 animate-spin"></i> Generando Idea...';
            lucide.createIcons();
            outputElement.textContent = 'Pensando en el diseño perfecto para ti...';
            outputContainer.classList.remove('hidden');

            const systemPrompt = "Eres un diseñador de interiores y fabricante de muebles de lujo. Genera una descripción inspiradora para un mueble personalizado basado en el estilo proporcionado. Incluye el tipo de mueble (e.g., sala, comedor), los materiales sugeridos (e.g., madera nogal, tapicería anti-manchas) y un nombre de colección atractivo. El resultado debe ser una descripción concisa y profesional, adecuada para un formulario de cotización. Responde en español.";
            const userQuery = `Estilo de diseño clave: "${keyword}". Crea una descripción de cotización para un mueble.`;
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${LLM_MODEL}:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
                config: {
                    temperature: 0.8
                }
            };

            try {
                const response = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "No se pudo generar una idea de diseño. Intenta con otra palabra clave.";
                
                outputElement.textContent = text;

            } catch (error) {
                console.error("Error al llamar a Gemini API para generar diseño:", error);
                outputElement.textContent = "Lo sentimos, hubo un error al generar la idea. Por favor, inténtalo más tarde.";
                showNotification('Error al contactar al Generador de Ideas.', 'bg-red-600');
            } finally {
                // Restaurar botón
                generateButton.disabled = false;
                generateButton.classList.remove('loading-button');
                generateButton.innerHTML = '<i data-lucide="wand-2" class="w-5 h-5 mr-2"></i> Generar Diseño';
                lucide.createIcons();
            }
        }
        
        function fillQuoteDetails() {
            const llmOutput = document.getElementById('llm-output').textContent;
            const detailsTextarea = document.getElementById('details');
            
            if (llmOutput && llmOutput !== 'Pensando en el diseño perfecto para ti...') {
                detailsTextarea.value = llmOutput;
                showNotification('Descripción de diseño copiada al campo de detalles.', 'bg-green-600');
            } else {
                showNotification('No hay contenido generado para aplicar.', 'bg-yellow-500');
            }
        }
        
        /*
        * 2. Asistente de Catálogo (TTS) - Catálogos
        */
        async function speakDescription(elementId, voiceName) {
            const element = document.getElementById(elementId);
            const textToSpeak = element.textContent;
            
            if (!textToSpeak) return;

            // Simple control para evitar múltiples reproducciones
            if (window.audioContext && window.audioSource) {
                window.audioSource.stop();
                window.audioContext.close();
                delete window.audioContext;
                delete window.audioSource;
            }

            showNotification('Generando audio de descripción. Espera un momento...', 'bg-primary');

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${TTS_MODEL}:generateContent?key=${apiKey}`;
            const prompt = `Describe la siguiente colección con un tono informativo y profesional: "${textToSpeak}"`;
            
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: {
                            prebuiltVoiceConfig: { voiceName: voiceName }
                        }
                    }
                }
            };

            try {
                const response = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/L16")) {
                    const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                    const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 24000;
                    
                    const pcmData = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmData);
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);

                    const audio = new Audio(audioUrl);
                    audio.play();
                    showNotification('Reproduciendo descripción.', 'bg-green-600');

                    audio.onended = () => {
                        URL.revokeObjectURL(audioUrl); // Limpiar URL
                    };
                } else {
                    throw new Error("Respuesta de audio inválida o incompleta.");
                }
                
            } catch (error) {
                console.error("Error en TTS API:", error);
                showNotification('Error al generar el audio. Asegúrate de que el texto sea claro.', 'bg-red-600');
            }
        }

        // --- Funciones Auxiliares para TTS ---
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function pcmToWav(pcm16, sampleRate) {
            const numChannels = 1;
            const bytesPerSample = 2; // Int16
            const blockAlign = numChannels * bytesPerSample;
            const byteRate = sampleRate * blockAlign;
            const bufferLength = pcm16.length * bytesPerSample;

            const buffer = new ArrayBuffer(44 + bufferLength);
            const view = new DataView(buffer);
            
            // RIFF chunk descriptor
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + bufferLength, true);
            writeString(view, 8, 'WAVE');
            
            // FMT sub-chunk
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);          // Subchunk1Size (16 for PCM)
            view.setUint16(20, 1, true);           // AudioFormat (1 for PCM)
            view.setUint16(22, numChannels, true); // NumChannels
            view.setUint32(24, sampleRate, true);  // SampleRate
            view.setUint32(28, byteRate, true);    // ByteRate
            view.setUint16(32, blockAlign, true);  // BlockAlign
            view.setUint16(34, 16, true);          // BitsPerSample (16-bit)

            // Data sub-chunk
            writeString(view, 36, 'data');
            view.setUint32(40, bufferLength, true); // Subchunk2Size

            // Escribir datos PCM
            let offset = 44;
            for (let i = 0; i < pcm16.length; i++, offset += 2) {
                view.setInt16(offset, pcm16[i], true);
            }

            return new Blob([view], { type: 'audio/wav' });
        }

        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }
        // --- Fin Funciones Auxiliares ---

        // --- Manejo de Modal de Confirmación (Reemplazo de confirm()) ---
        // Estructura del Modal de Confirmación
        const modalHtml = `
            <div id="custom-confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-[200]">
                <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm transform transition-all duration-300 scale-100 border-t-4 border-red-500">
                    <h3 class="text-xl font-bold text-red-700 mb-4 flex items-center">
                        <i data-lucide="alert-triangle" class="w-6 h-6 mr-2"></i> Confirmación
                    </h3>
                    <p id="confirm-message" class="text-gray-700 mb-6"></p>
                    <div class="flex justify-end space-x-3">
                        <button id="confirm-cancel" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition">Cancelar</button>
                        <button id="confirm-ok" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">Aceptar</button>
                    </div>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHtml);

        function showConfirmationModal(message) {
            return new Promise(resolve => {
                const modal = document.getElementById('custom-confirm-modal');
                const messageElement = document.getElementById('confirm-message');
                const okButton = document.getElementById('confirm-ok');
                const cancelButton = document.getElementById('confirm-cancel');
                
                messageElement.textContent = message;
                modal.style.display = 'flex';
                lucide.createIcons(); // Re-renderizar iconos en el modal

                const cleanup = (result) => {
                    modal.style.display = 'none';
                    okButton.onclick = null;
                    cancelButton.onclick = null;
                    resolve(result);
                };

                okButton.onclick = () => cleanup(true);
                cancelButton.onclick = () => cleanup(false);
            });
        }
        // --- Fin Manejo de Modal de Confirmación ---
        
        // --- LÓGICA DE VISTA / FRONT-END ---

        /*
        * Lógica para la Interacción de Palabras con Imágenes (Hero Section)
        */
        function updateHero(title, subtitle) {
            const heroTitle = document.getElementById('hero-title');
            const heroSubtitle = document.getElementById('hero-subtitle');
            
            heroTitle.innerHTML = `<span class="text-accent">${title}:</span> ${heroTitle.innerHTML.split(':')[1] || 'Elegancia en Cada Mueble.'}`;
            heroSubtitle.textContent = subtitle;
            
            const heroSection = document.getElementById('hero-section');
            heroSection.style.backgroundImage = `url('https://placehold.co/1920x800/4E342E/FFFFFF/webp?text=Mobiliario+de+${title}')`;
        }

        function resetHero() {
            const heroTitle = document.getElementById('hero-title');
            const heroSubtitle = document.getElementById('hero-subtitle');
            
            heroTitle.innerHTML = 'Diseños Aguilar: Elegancia en Cada Mueble.';
            heroSubtitle.textContent = 'Transformando espacios con el arte de la madera y el diseño.';
            
            const heroSection = document.getElementById('hero-section');
            heroSection.style.backgroundImage = `url('https://placehold.co/1920x800/5D4037/FFFFFF/webp?text=Salas+y+Comedores+Exclusivos')`;
        }

        /*
        * Lógica del Formulario de Cotización (No LLM related)
        */
        function handleQuoteSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const messageDiv = document.getElementById('quote-message');
            
            const quoteData = {
                name: form.name.value,
                email: form.email.value,
                phone: form.phone.value,
                details: form.details.value,
                timestamp: new Date().toISOString()
            };

            // Simulación de envío de datos
            console.log('--- SOLICITUD DE COTIZACIÓN ENVIADA ---');
            console.log(quoteData);
            console.log('--------------------------------------');

            // Mostrar mensaje de éxito y resetear formulario
            messageDiv.textContent = '¡Cotización enviada con éxito! Te contactaremos pronto.';
            messageDiv.classList.remove('hidden');
            form.reset();

            // Ocultar mensaje después de 5 segundos
            setTimeout(() => {
                messageDiv.classList.add('hidden');
            }, 5000);
        }

        /*
        * Lógica de Carrito de Compras (E-commerce Simulado)
        */
        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-CO', {
                style: 'currency',
                currency: 'COP',
                minimumFractionDigits: 0
            }).format(amount);
        }

        function updateCartUI() {
            const cartList = document.getElementById('cart-items-list');
            const cartTotalElement = document.getElementById('cart-total-price');
            const cartCountElement = document.getElementById('cart-count');
            const emptyMessage = document.getElementById('empty-cart-message');

            if (!cartList || !cartTotalElement || !cartCountElement || !emptyMessage) {
                console.error("Error al cargar elementos del carrito. Intentando de nuevo...");
                return; 
            }

            cartList.innerHTML = '';
            
            if (cart.length === 0) {
                emptyMessage.classList.remove('hidden');
                cartTotalElement.textContent = formatCurrency(0);
                cartCountElement.textContent = 0;
                return;
            }
            emptyMessage.classList.add('hidden');

            let total = 0;
            
            cart.forEach((item, index) => {
                total += item.price;
                const itemElement = document.createElement('div');
                itemElement.className = 'flex items-center justify-between border-b pb-2';
                itemElement.innerHTML = `
                    <div class="flex-grow">
                        <p class="font-semibold text-gray-800">${item.name}</p>
                        <p class="text-sm text-gray-500">${formatCurrency(item.price)}</p>
                    </div>
                    <button onclick="removeFromCart(${index})" class="text-red-500 hover:text-red-700 ml-4 transition duration-300">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                `;
                cartList.appendChild(itemElement);
            });

            cartTotalElement.textContent = formatCurrency(total);
            cartCountElement.textContent = cart.length;
            lucide.createIcons();
        }

        function addToCart(name, price) {
            cart.push({ name, price });
            updateCartUI();
            
            const cartButton = document.getElementById('cart-button').querySelector('button');
            cartButton.classList.add('animate-ping-once');
            setTimeout(() => {
                cartButton.classList.remove('animate-ping-once');
            }, 500);

            showNotification(`"${name}" añadido al carrito.`);
        }
        
        function removeFromCart(index) {
            const removedItem = cart[index].name;
            cart.splice(index, 1);
            updateCartUI();
            showNotification(`"${removedItem}" eliminado del carrito.`, 'bg-red-500');
        }

        function showCartModal() {
            const modal = document.getElementById('cart-modal');
            modal.style.display = 'flex';
            updateCartUI();
        }

        function hideCartModal() {
            document.getElementById('cart-modal').style.display = 'none';
        }
        
        function simulatePurchase() {
            if (cart.length === 0) {
                showNotification('El carrito está vacío. ¡Añade productos antes de comprar!', 'bg-yellow-500');
                return;
            }
            
            console.log('--- COMPRA FINALIZADA (Simulación) ---');
            console.log('Total a pagar:', formatCurrency(cart.reduce((sum, item) => sum + item.price, 0)));
            console.log('Productos comprados:', cart);
            console.log('------------------------------------');

            showNotification('¡Compra realizada con éxito! Recibirás la factura por correo.', 'bg-green-600');
            cart = []; // Vaciar carrito
            hideCartModal();
        }

        /*
        * Lógica de Notificación Temporal (Reemplazo de alert)
        */
        function showNotification(message, bgColor = 'bg-primary') {
            const existingNotification = document.getElementById('app-notification');
            if (existingNotification) existingNotification.remove();

            const notification = document.createElement('div');
            notification.id = 'app-notification';
            notification.className = `fixed top-4 left-1/2 transform -translate-x-1/2 p-4 rounded-lg text-white shadow-xl transition-opacity duration-300 opacity-0 ${bgColor}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Mostrar la notificación
            setTimeout(() => {
                notification.style.opacity = '1';
            }, 50);

            // Ocultar y remover la notificación
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 300);
            }, 4000);
        }

    </script>
</body>
</html>
